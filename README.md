# pdf-to-text-ru: Система обработки и распознавания PDF-документов

[![Python Version](https://img.shields.io/badge/python-3.10-blue.svg)](https://www.python.org/downloads/release/python-3100/)
[![License](https://img.shields.io/badge/license-MIT-green.svg)](LICENSE)

RAG2 — это Python-приложение для автоматизированной обработки PDF-документов с целью извлечения структурированного контента. Проект фокусируется на конвертации PDF в изображения, анализе разметки (layout analysis), распознавании текстовых и математических фрагментов, а также хранении результатов в базе данных. Это может быть полезно для задач Retrieval-Augmented Generation (RAG), анализа документов или OCR-приложений.

Проект вдохновлен лучшими практиками из книг "Чистая архитектура" Роберта Мартина, "Grokking Simplicity" Эрика Нормана, "Совершенный код" Стива Макконнелла и "Learning Domain-Driven Design" Влада Хонова. Код стремится к чистоте, читаемости, тестируемости и декларативности, с использованием функциональных приёмов где это уместно.

## Основные функции

- **Конвертация PDF в изображения**: Разбиение PDF на страницы с заданным DPI.
- **Анализ разметки**: Использование Docker-контейнера для выявления фрагментов (текст, таблицы, формулы, изображения и т.д.).
- **Распознавание фрагментов**:
  - Текст: Модель Qwen2-VL-OCR-2B-Instruct.
  - Формулы: Модель Pix2Text (ONNX).
- **Хранение данных**: SQLite база данных для документов, страниц, фрагментов и распознанных результатов.
- **Упорядочивание чтения**: Алгоритм для определения логического порядка фрагментов на странице.
- **Логирование**: Структурированное JSON-логирование для мониторинга.
- **Docker-интеграция**: Автоматический запуск контейнера для анализа layout.

## Требования

- Python 3.10+
- Docker (для анализа layout).
- CUDA (опционально, для ускорения моделей на GPU).
- Доступные GPU: Рекомендуется для моделей распознавания.

Зависимости (см. `environment.yml`):
- PyTorch, Transformers, Pillow, pdf2image, SQLAlchemy и другие.

## Установка

1. **Клонируйте репозиторий**:
   ```
   git clone https://github.com/your-repo/rag2.git
   cd rag2
   ```

2. **Создайте виртуальное окружение с Conda** (рекомендуется):
   ```
   conda env create -f environment.yml
   conda activate rag2
   ```

3. **Установите дополнительные pip-пакеты** (если не установлены через Conda):
   ```
   pip install -r requirements.txt
   ```
   (Создайте `requirements.txt` из `environment.yml` pip-секции, если нужно.)

4. **Настройте Docker**:
   - Убедитесь, что Docker установлен и запущен.
   - Проект использует образ `huridocs/pdf-document-layout-analysis:v0.0.24`.

5. **Инициализируйте базу данных**:
   - База данных создаётся автоматически при запуске в `./data/db/database.db`.

## Использование

### Основной запуск

Запустите основной скрипт для обработки PDF-файлов в `./data/input/pdfs`:
```
python main.py
```

- Входные PDF: `./data/input/pdfs`.
- Выходные изображения: `./data/images`.
- Логи: `./data/logs/convert_pdf_to_pages.log` (в JSON-формате).

### Очистка данных
Для удаления базы данных и изображений:
```
./purge_data.sh
```

### Конфигурация
Настройки в `src/settings.py`:
- `PDF_INPUT_DIR`: Директория входных PDF.
- `IMAGE_OUTPUT_DIR`: Директория для изображений.
- `LAYOUT_ANALYZER_URL`: URL Docker-контейнера (по умолчанию `http://localhost:5060`).
- `TEXT_RECOGNIZER_MODEL_NAME`: Модель для OCR-текста.
- `FORMULA_RECOGNIZER_MODEL_DIR`: Путь к модели Pix2Text.

Измените настройки по необходимости и перезапустите приложение.

### Пример workflow
1. Поместите PDF в `./data/input/pdfs`.
2. Запустите `main.py`: 
   - Конвертирует PDF в страницы.
   - Анализирует layout.
   - Распознаёт текст в фрагментах (для документа "test").
3. Результаты: Изображения фрагментов в `./data/images/<filename>`, данные в БД.

## Структура проекта

```
rag2/
├── data/                  # Данные: input, images, db, logs, cache
├── src/                   # Основной код
│   ├── config.py          # DI-контейнер и настройки логирования
│   ├── converters/        # Конвертация PDF в изображения
│   ├── database/          # Модели SQLAlchemy
│   ├── entities.py        # Доменные сущности (Document, Page, Fragment)
│   ├── recognizers/       # Распознаватели (текст, формулы, layout)
│   ├── repository/        # Репозитории для БД
│   ├── settings.py        # Конфигурация приложения
│   ├── utils/             # Утилиты (координаты, Docker, изображения)
│   └── workflows/         # Основные пайплайны (process_pdf, recognize_fragments)
├── tests/                 # Тесты (pytest)
├── main.py                # Точка входа
├── environment.yml        # Conda-окружение
├── pyproject.toml         # Black для форматирования
├── purge_data.sh          # Скрипт очистки
└── README.md              # Этот файл
```

Код разбит на мелкие функции с единственной ответственностью, декларативным стилем и минимальными комментариями. Используются dataclasses, enums и typing для читаемости.

## Тестирование

Тесты пока что некорректные.

## Вклад

Если готовы принять участие в разарботке проекта, я буду рад.

- Форкните репозиторий.
- Создайте ветку: `git checkout -b feature/new-feature`.
- Коммитите изменения: `git commit -m "Добавлена новая функция"`.
- Пушьте: `git push origin feature/new-feature`.
- Создайте Pull Request.

Следуйте стилю кода: Black (line-length=100), избегайте мутабельности где возможно.

## Лицензия

MIT License. См. [LICENSE](LICENSE) для деталей.

## Контакты

- Автор: [github.com/say1ts] (say1ts).
- Email: [tsydenovsayan@gmail.com].
- Вопросы: Открывайте issues в репозитории.
